name: Update Telegram API JSON

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout workflow repo (tgapis/docs)
      - name: Checkout tgapis/docs
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Clone tgapis/x (data branch)
      - name: Clone tgapis/x (data branch)
        run: |
          git clone --branch data --depth 1 https://github.com/tgapis/x tgapis-x

      # 3Ô∏è‚É£ Clone PRIVATE tgdocsapi (output repo)
      - name: Clone tgapis/tgdocsapi (output)
        run: |
          git clone https://x-access-token:${{ secrets.TGDOCS_PAT }}@github.com/tgapis/tgdocsapi output

      # 4Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 5Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          pip install beautifulsoup4 lxml

      # 6Ô∏è‚É£ Copy Telegram HTML data (EXACT STRUCTURE)
      - name: Prepare Telegram HTML data
        run: |
          mkdir -p output/docs
          cp -r tgapis-x/Telegram output/docs/

      # 7Ô∏è‚É£ Run tl.py with correct path
      - name: Generate tlapi.json
        run: |
          cd output
          TG_DOCS_PATH="$(pwd)/docs/Telegram" python tl.py

      # 8Ô∏è‚É£ Cleanup input docs AFTER generation
      - name: Cleanup input docs
        run: |
          rm -rf output/docs

      # 9Ô∏è‚É£ Fetch botapi.json
      - name: Fetch botapi.json
        run: |
          curl -L \
          https://raw.githubusercontent.com/tgapis/x/data/botapi.json \
          -o output/botapi.json

      # üîü Safety check ‚Äì ONLY two files allowed
      - name: Safety check (only JSON files)
        run: |
          cd output
          git status --porcelain | awk '{print $2}' | grep -vE '^(tlapi.json|botapi.json)$' && exit 1 || true

      # 1Ô∏è‚É£1Ô∏è‚É£ Commit & push
      - name: Commit and push changes
        id: commit
        run: |
          cd output
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add tlapi.json botapi.json

          if git diff --cached --quiet; then
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "auto: update tlapi.json & botapi.json"
            git push
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      # üîî Notify owner (only if pushed)
      - name: Notify owner on Telegram
        if: steps.commit.outputs.pushed == 'true'
        run: |
          MESSAGE="‚úÖ *Telegram API JSON Updated*\n\n‚Ä¢ tlapi.json\n‚Ä¢ botapi.json\n\n‚è± $(date -u)"
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.OWNER_ID }}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
